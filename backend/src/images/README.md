# Images Module

موديول الصور مسؤول عن رفع صور المنتجات، حفظ البيانات الوصفية، وإدارة طوابير المعالجة (مثل إضافة العلامة المائية) مع توفير واجهات وصول للمستخدمين.

## المكونات
- `ImagesModule`: يربط مخططات `Product`, `Image`, `Category`, `JobStatus`, يسجل طابور Bull `image-processing`, ويستورد `StorageModule`.
- `ImagesController`: يوفّر المسارات `/images`:
  - `POST /images/upload` لرفع الملفات (multipart/form-data) مع استخدام `multer`.
  - `GET /images` لاسترجاع القائمة مع التصفية والترقيم.
  - `GET /images/:id/download-url` لإصدار رابط تحميل مؤقت.
  - `PATCH /images/:id/watermark-toggle` لتبديل حالة العلامة المائية (خاصة بالأدمن).
- `ImagesService`: يطبق منطق التحقق من الفئات، إنشاء المنتجات عند الحاجة، رفع الملفات إلى التخزين (S3 عبر `StorageService`)، إدارة وظائف Bull، واسترجاع البيانات.
- `WatermarkProcessor`: مستهلك طابور Bull الموجود في `processors/` لمعالجة الصور وإضافة العلامات المائية (راجع الملف للتفاصيل).
- DTOs (`UploadImageDto`, `ImageQueryDto`): تحدد بنية الطلبات وقواعد التحقق.

## التدفق: رفع صورة
1. المستخدم يرسل طلب `multipart/form-data` يحتوي الملف وبيانات المنتج.
2. يتم تخزين الملف مؤقتاً عبر `multer` ثم رفعه إلى التخزين الدائم بواسطة `StorageService`.
3. يتم إنشاء منتج جديد إن لم يوجد (مرتبط بالفئة) ثم إنشاء سجل صورة.
4. يتم إدراج مهمة في طابور Bull لمعالجة العلامة المائية وتحديث حالة الصورة (`jobId`, `status`, `progress`).

## الاستعلام عن الصور
- يدعم الاستعلام الترقيم (page/limit) والبحث `q` عبر خصائص المنتج (`description`, `productName`, `productCode`, `tags`, `note`) بالإضافة إلى فلترة `category` و `model`.
- يتم تحميل بيانات المنتج والفئة لإرجاع معلومات غنية (اسم الفئة، الحالة، الروابط).

## الروابط المؤقتة والتنقل
- `getDownloadUrl` يولّد رابط Presigned عبر `StorageService` مع التحقق من وجود الملف.
- `toggleWatermark` يسمح بتفعيل/تعطيل حالة العلامة المائية (للأدمن فقط، مع `RolesGuard`).

## المتطلبات
- إعداد Mongoose للمخططات الأربعة.
- إعداد Bull + Redis ووحدة `StorageModule` المتصلة بـ S3 أو مزود متوافق.
- تفعيل `JwtAuthGuard` عالمياً و `RolesGuard` لمسارات محددة.

## التوسعة والاختبارات
- يمكن إضافة دعم لعدة ملفات، تتبع حالات إضافية، أو تحديث بيانات الصور بتوسيع `ImagesService`.
- يفضل كتابة اختبارات تكامل تغطي سيناريوهات الرفع، الفلترة، توليد الروابط، وتبديل العلامة المائية مع استخدام مزودات تخزين/طابور وهمية.

